# Workflow 07 : Artifacts - Partager des fichiers entre jobs
# Objectif : Sauvegarder et récupérer des fichiers (modèles, données, rapports)

name: 07 - Artifacts et Partage

on:
  workflow_dispatch:

jobs:
  # Job 1 : Entraîner et sauvegarder le modèle
  entrainement:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Installer dépendances
        run: pip install numpy scikit-learn joblib
      
      - name: Créer et entraîner le modèle
        run: |
          python << 'EOF'
          import joblib
          import json
          from sklearn.datasets import make_classification
          from sklearn.ensemble import RandomForestClassifier
          from sklearn.model_selection import train_test_split
          
          # Générer des données
          X, y = make_classification(n_samples=1000, n_features=20, 
                                      n_informative=15, random_state=42)
          X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2)
          
          # Entraîner
          model = RandomForestClassifier(n_estimators=100, random_state=42)
          model.fit(X_train, y_train)
          
          # Métriques
          train_score = model.score(X_train, y_train)
          test_score = model.score(X_test, y_test)
          
          # Sauvegarder le modèle
          joblib.dump(model, 'model.pkl')
          
          # Sauvegarder les métriques
          metrics = {
              'train_accuracy': float(train_score),
              'test_accuracy': float(test_score),
              'n_estimators': 100,
              'n_features': 20
          }
          
          with open('metrics.json', 'w') as f:
              json.dump(metrics, f, indent=2)
          
          print(f"Train accuracy: {train_score:.4f}")
          print(f"Test accuracy: {test_score:.4f}")
          EOF
      
      # ⬇️ UPLOAD : Sauvegarder les fichiers comme artifacts
      - name: Upload du modèle et des métriques
        uses: actions/upload-artifact@v4
        with:
          name: ml-artifacts
          path: |
            model.pkl
            metrics.json
          retention-days: 7  # Garde les artifacts pendant 7 jours
  
  # Job 2 : Charger le modèle et faire des prédictions
  prediction:
    runs-on: ubuntu-latest
    needs: entrainement  # Attend que l'entraînement soit terminé
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Installer dépendances
        run: pip install numpy scikit-learn joblib
      
      # ⬇️ DOWNLOAD : Récupérer les artifacts du job précédent
      - name: Télécharger le modèle et les métriques
        uses: actions/download-artifact@v4
        with:
          name: ml-artifacts
      
      - name: Vérifier les fichiers téléchargés
        run: |
          echo "Fichiers présents:"
          ls -lh
      
      - name: Charger le modèle et prédire
        run: |
          python << 'EOF'
          import joblib
          import numpy as np
          import json
          
          # Charger les métriques
          with open('metrics.json', 'r') as f:
              metrics = json.load(f)
          
          print("=== MÉTRIQUES DU MODÈLE ===")
          print(json.dumps(metrics, indent=2))
          print()
          
          # Charger le modèle
          model = joblib.load('model.pkl')
          print(f"Modèle chargé : {type(model).__name__}")
          print(f"Nombre d'arbres : {model.n_estimators}")
          print()
          
          # Faire des prédictions sur de nouvelles données
          print("=== PRÉDICTIONS ===")
          X_new = np.random.randn(5, 20)
          predictions = model.predict(X_new)
          probas = model.predict_proba(X_new)
          
          for i, (pred, proba) in enumerate(zip(predictions, probas)):
              print(f"Sample {i+1}: Classe {pred} (confiance: {proba[pred]:.2%})")
          EOF
  
  # Job 3 : Générer un rapport
  rapport:
    runs-on: ubuntu-latest
    needs: prediction
    steps:
      - name: Télécharger les métriques
        uses: actions/download-artifact@v4
        with:
          name: ml-artifacts
      
      - name: Générer un rapport HTML
        run: |
          python << 'EOF'
          import json
          
          with open('metrics.json', 'r') as f:
              metrics = json.load(f)
          
          html = f"""
          <!DOCTYPE html>
          <html>
          <head>
              <title>Rapport ML</title>
              <style>
                  body {{ font-family: Arial; margin: 40px; }}
                  .metric {{ background: #f0f0f0; padding: 15px; margin: 10px 0; }}
              </style>
          </head>
          <body>
              <h1>Rapport d'Entraînement ML</h1>
              <div class="metric">
                  <h3>Précision Train</h3>
                  <p>{metrics['train_accuracy']:.4f}</p>
              </div>
              <div class="metric">
                  <h3>Précision Test</h3>
                  <p>{metrics['test_accuracy']:.4f}</p>
              </div>
              <div class="metric">
                  <h3>Configuration</h3>
                  <p>Arbres: {metrics['n_estimators']}</p>
                  <p>Features: {metrics['n_features']}</p>
              </div>
          </body>
          </html>
          """
          
          with open('rapport.html', 'w') as f:
              f.write(html)
          
          print("Rapport HTML généré !")
          EOF
      
      - name: Upload du rapport
        uses: actions/upload-artifact@v4
        with:
          name: rapport-html
          path: rapport.html
# Workflow 08 : Matrix Strategy - Tester sur plusieurs configurations
# Objectif : Exécuter le même job avec différentes versions/OS/configurations

name: 08 - Matrix Build

on:
  workflow_dispatch:

jobs:
  # Test le modèle sur différentes versions de Python
  test-multi-python:
    runs-on: ubuntu-latest
    
    # ⬇ STRATEGY MATRIX : Définit les variables qui changeront
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
        # Le job sera exécuté 3 fois en parallèle (une fois par version)
        
    
    steps:
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Afficher la version
        run: python --version
      
      - name: Installer et tester
        run: |
          pip install numpy scikit-learn
          python << 'EOF'
          import sys
          import sklearn
          import numpy as np
          
          print(f"Python: {sys.version}")
          print(f"NumPy: {np.__version__}")
          print(f"Scikit-learn: {sklearn.__version__}")
          
          # Test simple
          from sklearn.datasets import make_classification
          from sklearn.ensemble import RandomForestClassifier
          
          X, y = make_classification(n_samples=100, n_features=10)
          model = RandomForestClassifier(n_estimators=10)
          model.fit(X, y)
          print(f"Précision: {model.score(X, y):.2f}")
          EOF
  
  # Test sur différents OS et algorithmes
  test-multi-os-algo:
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
        algorithme: [RandomForest, SVM, LogisticRegression]
      # Total: 3 OS × 3 algos = 9 jobs en parallèle !
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Installer dépendances
        run: pip install numpy scikit-learn
      
      - name: Tester ${{ matrix.algorithme }} sur ${{ matrix.os }}
        run: |
          python << 'EOF'
          import platform
          from sklearn.datasets import make_classification
          from sklearn.ensemble import RandomForestClassifier
          from sklearn.svm import SVC
          from sklearn.linear_model import LogisticRegression
          
          print(f"OS: {platform.system()} {platform.release()}")
          print(f"Algorithme: ${{ matrix.algorithme }}")
          
          X, y = make_classification(n_samples=100, n_features=10, random_state=42)
          
          # Sélectionner l'algorithme selon la matrice
          if "${{ matrix.algorithme }}" == "RandomForest":
              model = RandomForestClassifier(n_estimators=10, random_state=42)
          elif "${{ matrix.algorithme }}" == "SVM":
              model = SVC(random_state=42)
          else:  # LogisticRegression
              model = LogisticRegression(random_state=42, max_iter=200)
          
          model.fit(X, y)
          score = model.score(X, y)
          print(f"Précision: {score:.4f}")
          print("✅ Test réussi !")
          EOF
  
  # Matrix avec exclusions
  test-avec-exclusions:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.9', '3.10', '3.11']
        sklearn-version: ['1.2.2', '1.3.0']
        # Exclure certaines combinaisons problématiques
        exclude:
          - python-version: '3.9'
            sklearn-version: '1.3.0'  # Incompatible
      # Résultat: 5 jobs au lieu de 6 (3×2 - 1 exclusion)
    
    steps:
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Installer scikit-learn ${{ matrix.sklearn-version }}
        run: |
          pip install scikit-learn==${{ matrix.sklearn-version }}
          python -c "import sklearn; print(f'Scikit-learn: {sklearn.__version__}')"
  
  # Matrix avec includes pour ajouter des combinaisons spéciales
  test-avec-includes:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        python-version: ['3.10']
        include:
          # Ajouter une configuration spéciale de test
          - python-version: '3.11'
            experimental: true
            description: "Version expérimentale"
    
    steps:
      - name: Setup Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}
      
      - name: Info
        run: |
          echo "Python: ${{ matrix.python-version }}"
          echo "Expérimental: ${{ matrix.experimental }}"
          echo "Description: ${{ matrix.description }}"
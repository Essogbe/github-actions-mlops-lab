# Workflow 11 : Secrets et Environnements
# Objectif : G√©rer des secrets et utiliser des environnements avec r√®gles de protection

name: 11 - Secrets et Environnements

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environnement cible'
        required: true
        type: choice
        options:
          - development
          - staging
          - production

env:
  # Variables publiques (pas sensibles)
  REGION: 'us-east-1'
  APP_NAME: 'ml-model-api'

jobs:
  # Job de d√©veloppement (pas de secrets critiques)
  dev-deployment:
    runs-on: ubuntu-latest
    # ‚¨áÔ∏è Utilise l'environnement 'development' (cr√©er dans Settings > Environments)
    environment: development
    # S'ex√©cute seulement si l'input est 'development'
    if: github.event.inputs.environment == 'development'
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Afficher info environnement
        run: |
          echo "üîß Environnement: Development"
          echo "R√©gion: $REGION"
          echo "Application: $APP_NAME"
      
      # Utiliser des secrets de l'environnement
      # Note: Ces secrets doivent √™tre cr√©√©s dans Settings > Environments > development
      - name: Utiliser les secrets de dev
        env:
          # Les secrets sont masqu√©s dans les logs (apparaissent comme ***)
          API_KEY: ${{ secrets.DEV_API_KEY }}
          DB_PASSWORD: ${{ secrets.DEV_DB_PASSWORD }}
        run: |
          echo "API Key pr√©sente: $([[ -n "$API_KEY" ]] && echo 'OUI' || echo 'NON')"
          echo "DB Password pr√©sent: $([[ -n "$DB_PASSWORD" ]] && echo 'OUI' || echo 'NON')"
          # Les valeurs r√©elles ne seront JAMAIS affich√©es
          echo "Tentative d'affichage du secret: $API_KEY"
          # ‚¨ÜÔ∏è Appara√Ætra comme: ***
      
      - name: Simuler d√©ploiement dev
        run: |
          echo "üì¶ Installation des d√©pendances..."
          pip install numpy scikit-learn
          echo "üöÄ D√©ploiement sur serveur de dev..."
          echo "‚úÖ D√©ploiement dev termin√©"
  
  # Job de staging avec quelques protections
  staging-deployment:
    runs-on: ubuntu-latest
    environment: staging
    if: github.event.inputs.environment == 'staging'
    
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Afficher info environnement
        run: |
          echo "üß™ Environnement: Staging"
          echo "R√©gion: $REGION"
      
      - name: Utiliser secrets de staging
        env:
          API_KEY: ${{ secrets.STAGING_API_KEY }}
          DB_PASSWORD: ${{ secrets.STAGING_DB_PASSWORD }}
        run: |
          echo "Configuration staging charg√©e"
          echo "API Key disponible: $([[ -n "$API_KEY" ]] && echo 'OUI' || echo 'NON')"
      
      - name: Tests d'int√©gration
        run: |
          pip install numpy scikit-learn requests
          python << 'EOF'
          print("üß™ Ex√©cution des tests d'int√©gration...")
          print("‚úÖ Tests API: OK")
          print("‚úÖ Tests DB: OK")
          print("‚úÖ Tests mod√®le: OK")
          EOF
      
      - name: D√©ploiement staging
        run: |
          echo "üöÄ D√©ploiement sur staging..."
          echo "‚úÖ Staging d√©ploy√©"
  
  # Job de production avec protections maximales
  production-deployment:
    runs-on: ubuntu-latest
    # ‚¨áÔ∏è Environment avec r√®gles de protection (√† configurer dans Settings)
    environment:
      name: production
      url: https://api.mon-app.com  # URL affich√©e dans l'interface
    if: github.event.inputs.environment == 'production'
    
    steps:
      - name: V√©rifications pr√©-d√©ploiement
        run: |
          echo "‚ö†Ô∏è  PRODUCTION DEPLOYMENT"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Triggered by: ${{ github.actor }}"
          echo "Commit: ${{ github.sha }}"
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      # Secrets de production (les plus sensibles)
      - name: Charger secrets production
        env:
          API_KEY: ${{ secrets.PROD_API_KEY }}
          DB_PASSWORD: ${{ secrets.PROD_DB_PASSWORD }}
          AWS_ACCESS_KEY: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        run: |
          echo "üîê Secrets de production charg√©s"
          echo "Tous les secrets sont masqu√©s dans les logs"
      
      - name: Tests de sant√©
        run: |
          pip install numpy scikit-learn
          python << 'EOF'
          print("üè• Health checks...")
          print("‚úÖ API Health: OK")
          print("‚úÖ Database Health: OK")
          print("‚úÖ Model Service: OK")
          EOF
      
      - name: Backup pr√©-d√©ploiement
        run: |
          echo "üíæ Cr√©ation d'un backup de s√©curit√©..."
          echo "‚úÖ Backup cr√©√©: backup-$(date +%Y%m%d-%H%M%S)"
      
      - name: D√©ploiement production
        run: |
          echo "üöÄ D√âPLOIEMENT EN PRODUCTION"
          echo "Region: $REGION"
          echo "Application: $APP_NAME"
          echo "‚úÖ PRODUCTION D√âPLOY√âE"
      
      - name: Tests post-d√©ploiement
        run: |
          echo "üß™ Tests post-d√©ploiement..."
          sleep 5
          echo "‚úÖ Tous les tests post-d√©ploiement OK"
      
      - name: Notification
        run: |
          echo "üìß Envoi de notifications..."
          echo "‚úÖ √âquipe notifi√©e du d√©ploiement"
  
  # Job utilisant le GITHUB_TOKEN automatique
  github-api-demo:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Utiliser le GITHUB_TOKEN automatique
        env:
          # GITHUB_TOKEN est automatiquement disponible
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "Le GITHUB_TOKEN permet d'interagir avec l'API GitHub"
          echo "Permissions: lecture du repo, √©criture des statuts, etc."
          
          # Exemple: lister les branches (n√©cessite gh cli ou curl)
          echo "Repository: ${{ github.repository }}"

# ========================================
# INSTRUCTIONS POUR CONFIGURER LES ENVIRONNEMENTS
# ========================================
#
# 1. Aller dans Settings > Environments
# 2. Cr√©er 3 environnements: development, staging, production
#
# 3. Pour chaque environnement:
#    - Ajouter les secrets appropri√©s (DEV_API_KEY, etc.)
#    - Configurer les r√®gles de protection:
#
# DEVELOPMENT:
#    - Pas de r√®gles particuli√®res
#
# STAGING:
#    - Optionnel: Wait timer de 5 minutes
#    - Deployment branches: main, develop
#
# PRODUCTION:
#    - ‚ö†Ô∏è  Required reviewers: ajouter 1-6 personnes qui doivent approuver
#    - Wait timer: 10-15 minutes (temps de r√©flexion)
#    - Deployment branches: main SEULEMENT
#    - Environment secrets: PROD_API_KEY, PROD_DB_PASSWORD, etc.
#
# 4. Cr√©er les secrets:
#    Repository secrets (Settings > Secrets and variables > Actions):
#    - Secrets communs √† tous les environnements
#
#    Environment secrets (Settings > Environments > [env] > Secrets):
#    - DEV_API_KEY, DEV_DB_PASSWORD (dans development)
#    - STAGING_API_KEY, STAGING_DB_PASSWORD (dans staging)
#    - PROD_API_KEY, PROD_DB_PASSWORD, AWS_* (dans production)
#
# ========================================
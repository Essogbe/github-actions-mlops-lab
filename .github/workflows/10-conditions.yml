# Workflow 10 : Logique Conditionnelle
# Objectif : Ex√©cuter des jobs/steps selon des conditions

name: 10 - Logique Conditionnelle

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]
  workflow_dispatch:
    inputs:
      deploy:
        description: 'D√©ployer en production ?'
        required: true
        type: boolean
        default: false
      environment:
        description: 'Environnement cible'
        required: true
        type: choice
        options:
          - dev
          - staging
          - production

jobs:
  # Job qui s'ex√©cute SEULEMENT sur la branche main
  deploy-production:
    runs-on: ubuntu-latest
    # ‚¨áÔ∏è Condition au niveau du JOB
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    
    steps:
      - name: Message de d√©ploiement
        run: |
          echo "üöÄ D√©ploiement en PRODUCTION"
          echo "Branche: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
  
  # Job qui s'ex√©cute sur develop ou feature branches
  deploy-staging:
    runs-on: ubuntu-latest
    if: github.ref != 'refs/heads/main'
    
    steps:
      - name: Message de d√©ploiement
        run: |
          echo "üß™ D√©ploiement en STAGING"
          echo "Branche: ${{ github.ref_name }}"
  
  # Job avec conditions au niveau des steps
  tests:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Installer d√©pendances
        run: pip install numpy scikit-learn pytest
      
      # Step qui s'ex√©cute toujours
      - name: Tests unitaires (toujours)
        run: |
          echo "‚úÖ Ex√©cution des tests unitaires..."
          python -c "print('Tests OK')"
      
      # Step qui s'ex√©cute SEULEMENT sur main
      - name: Tests d'int√©gration (main seulement)
        if: github.ref == 'refs/heads/main'
        run: |
          echo "üîó Ex√©cution des tests d'int√©gration..."
          python -c "print('Tests d\'int√©gration OK')"
      
      # Step qui s'ex√©cute SEULEMENT sur les PRs
      - name: Tests de r√©gression (PR seulement)
        if: github.event_name == 'pull_request'
        run: |
          echo "üìä Ex√©cution des tests de r√©gression..."
          python -c "print('Tests de r√©gression OK')"
      
      # Step qui s'ex√©cute SEULEMENT en d√©clenchement manuel
      - name: Tests de performance (manuel seulement)
        if: github.event_name == 'workflow_dispatch'
        run: |
          echo "‚ö° Ex√©cution des tests de performance..."
          python -c "print('Tests de performance OK')"
  
  # Job avec conditions bas√©es sur les inputs
  deploiement-conditionnel:
    runs-on: ubuntu-latest
    # S'ex√©cute seulement si d√©clench√© manuellement
    if: github.event_name == 'workflow_dispatch'
    
    steps:
      - name: V√©rifier l'environnement
        run: |
          echo "Environnement demand√©: ${{ github.event.inputs.environment }}"
          echo "D√©ploiement autoris√©: ${{ github.event.inputs.deploy }}"
      
      # D√©ployer SEULEMENT si deploy = true
      - name: D√©ploiement (si autoris√©)
        if: github.event.inputs.deploy == 'true'
        run: |
          echo "üöÄ D√âPLOIEMENT EN COURS..."
          echo "Cible: ${{ github.event.inputs.environment }}"
      
      # Message si d√©ploiement refus√©
      - name: D√©ploiement refus√©
        if: github.event.inputs.deploy == 'false'
        run: |
          echo "‚ùå D√©ploiement non autoris√©"
          echo "Environnement: ${{ github.event.inputs.environment }}"
      
      # V√©rifications suppl√©mentaires pour production
      - name: V√©rifications production
        if: github.event.inputs.environment == 'production' && github.event.inputs.deploy == 'true'
        run: |
          echo "‚ö†Ô∏è  D√âPLOIEMENT EN PRODUCTION"
          echo "V√©rifications de s√©curit√© suppl√©mentaires..."
          echo "‚úÖ Toutes les v√©rifications pass√©es"
  
  # Job avec conditions compos√©es
  validation-avancee:
    runs-on: ubuntu-latest
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Installer d√©pendances
        run: pip install numpy scikit-learn
      
      # Utiliser une step pour d√©finir une condition personnalis√©e
      - name: Entra√Æner mod√®le simple
        id: train_simple
        run: |
          python << 'EOF'
          import os
          from sklearn.datasets import make_classification
          from sklearn.ensemble import RandomForestClassifier
          
          X, y = make_classification(n_samples=100, n_features=10, random_state=42)
          model = RandomForestClassifier(n_estimators=10, random_state=42)
          model.fit(X, y)
          
          accuracy = model.score(X, y)
          print(f"Pr√©cision: {accuracy:.4f}")
          
          # D√©finir si le mod√®le est assez bon
          is_good = accuracy > 0.85
          
          with open(os.environ['GITHUB_OUTPUT'], 'a') as f:
              f.write(f"accuracy={accuracy}\n")
              f.write(f"is_good_model={'true' if is_good else 'false'}\n")
          EOF
      
      # S'ex√©cute SEULEMENT si le mod√®le est bon
      - name: Entra√Æner mod√®le complexe (si mod√®le simple bon)
        if: steps.train_simple.outputs.is_good_model == 'true'
        run: |
          echo "‚úÖ Le mod√®le simple est bon (>85%)"
          echo "üöÄ Entra√Ænement d'un mod√®le plus complexe..."
          python << 'EOF'
          from sklearn.datasets import make_classification
          from sklearn.ensemble import RandomForestClassifier
          
          X, y = make_classification(n_samples=1000, n_features=50, random_state=42)
          model = RandomForestClassifier(n_estimators=100, random_state=42)
          model.fit(X, y)
          print(f"Pr√©cision mod√®le complexe: {model.score(X, y):.4f}")
          EOF
      
      # S'ex√©cute SEULEMENT si le mod√®le est mauvais
      - name: Alerte mod√®le insuffisant
        if: steps.train_simple.outputs.is_good_model == 'false'
        run: |
          echo "‚ùå Le mod√®le simple est insuffisant (<85%)"
          echo "Pr√©cision obtenue: ${{ steps.train_simple.outputs.accuracy }}"
          echo "V√©rifier les donn√©es et hyperparam√®tres"
  
  # Job qui s'ex√©cute toujours (m√™me si les autres √©chouent)
  nettoyage:
    runs-on: ubuntu-latest
    if: always()  # ‚¨ÖÔ∏è S'ex√©cute toujours (succ√®s, √©chec, ou annulation)
    needs: [tests, validation-avancee]
    
    steps:
      - name: Nettoyage
        run: |
          echo "üßπ Nettoyage des ressources temporaires..."
          echo "Ce job s'ex√©cute m√™me si les pr√©c√©dents ont √©chou√©"
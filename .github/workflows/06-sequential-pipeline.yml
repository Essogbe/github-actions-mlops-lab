# Workflow 06 : Jobs Séquentiels avec 'needs'
# Objectif : Chaîner les jobs pour créer un pipeline ML

name: 06 - Pipeline ML Séquentiel

on:
  workflow_dispatch:

jobs:
  # Job 1 : Validation du code (linting)
  linting:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Installer flake8
        run: pip install flake8
      
      - name: Créer un script à valider
        run: |
          cat > model.py << 'EOF'
          import numpy as np
          from sklearn.ensemble import RandomForestClassifier
          
          def train_model(X, y):
              """Entraîne un modèle Random Forest"""
              model = RandomForestClassifier(n_estimators=100, random_state=42)
              model.fit(X, y)
              return model
          EOF
      
      - name: Linting avec flake8
        run: flake8 model.py --max-line-length=100
  
  # Job 2 : Tests unitaires (attend que le linting soit OK)
  tests:
    runs-on: ubuntu-latest
    needs: linting  #  Attend que 'linting' soit terminé avec succès
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Installer dépendances
        run: pip install pytest numpy scikit-learn
      
      - name: Créer des tests
        run: |
          cat > test_model.py << 'EOF'
          import numpy as np
          from sklearn.datasets import make_classification
          from sklearn.ensemble import RandomForestClassifier
          
          def test_model_training():
              X, y = make_classification(n_samples=100, n_features=10, random_state=42)
              model = RandomForestClassifier(n_estimators=10, random_state=42)
              model.fit(X, y)
              score = model.score(X, y)
              assert score > 0.8, "Le modèle doit avoir au moins 80% de précision"
          
          def test_predictions():
              X, y = make_classification(n_samples=100, n_features=10, random_state=42)
              model = RandomForestClassifier(n_estimators=10, random_state=42)
              model.fit(X, y)
              predictions = model.predict(X[:5])
              assert len(predictions) == 5, "Doit prédire 5 valeurs"
          EOF
      
      - name: Exécuter les tests
        run: pytest test_model.py -v
  
  # Job 3 : Entraînement (attend que les tests soient OK)
  entrainement:
    runs-on: ubuntu-latest
    needs: tests  #  Attend que 'tests' soit terminé avec succès
    steps:
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
      
      - name: Installer dépendances
        run: pip install numpy scikit-learn joblib
      
      - name: Entraîner le modèle
        run: |
          python << 'EOF'
          import joblib
          from sklearn.datasets import make_classification
          from sklearn.ensemble import RandomForestClassifier
          from sklearn.model_selection import train_test_split
          
          print("Génération des données...")
          X, y = make_classification(n_samples=1000, n_features=20, random_state=42)
          X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2)
          
          print("Entraînement du modèle...")
          model = RandomForestClassifier(n_estimators=100, random_state=42)
          model.fit(X_train, y_train)
          
          score = model.score(X_test, y_test)
          print(f"Précision sur le test set: {score:.4f}")
          
          print("Sauvegarde du modèle...")
          joblib.dump(model, 'model.pkl')
          EOF
      
      - name: Vérifier le fichier modèle
        run: ls -lh model.pkl
  
  # Job 4 : Rapport final (attend que l'entraînement soit OK)
  rapport:
    runs-on: ubuntu-latest
    needs: entrainement  #  Attend que 'entrainement' soit terminé
    steps:
      - name: Générer le rapport
        run: |
          echo "========================================="
          echo "   PIPELINE ML TERMINÉ AVEC SUCCÈS"
          echo "========================================="
          echo ""
          echo "✅ Linting validé"
          echo "✅ Tests unitaires passés"
          echo "✅ Modèle entraîné"
          echo "✅ Modèle sauvegardé"
          echo ""
          echo "Temps d'exécution :  secondes"
          echo "========================================="